name: Broadcast to Subscribers

on:
  workflow_dispatch:
    inputs:
      issue_date:
        description: 'Date of issue to send (YYYY-MM-DD or today)'
        required: true
        default: 'today'

jobs:
  broadcast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # We assume the issue was already generated by the preview workflow
      # so we don't need to generate it again, just pull the repo.
      # However, if 'today' is used, we need to resolve it.
      
      - name: Send to All Subscribers
        env:
          NEWSLETTER_GMAIL_USER: ${{ secrets.NEWSLETTER_GMAIL_USER }}
          NEWSLETTER_GMAIL_APP_PASSWORD: ${{ secrets.NEWSLETTER_GMAIL_APP_PASSWORD }}
          NEWSLETTER_FROM_EMAIL: ${{ secrets.NEWSLETTER_FROM_EMAIL }}
        run: |
          python3 send_newsletter.py \
            --issue-date "${{ github.event.inputs.issue_date }}" \
            --issues-dir issues \
            --subscribers subscribers.csv \
            --output-dir out
