<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Curate Newsletter Issue</title>
    <style>
      :root {
        color-scheme: light;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: #f8fafc;
        color: #0f172a;
      }
      .wrap {
        max-width: 1200px;
        margin: 32px auto 80px;
        padding: 0 20px;
      }
      h1 {
        font-size: 28px;
        margin: 0 0 8px;
      }
      h2 {
        font-size: 20px;
        margin: 32px 0 12px;
      }
      p.help {
        color: #64748b;
        margin: 0 0 24px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      }
      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }
      .label {
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .value {
        font-weight: 600;
      }
      .btn {
        border: 0;
        border-radius: 8px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-primary {
        background: #0ea5e9;
        color: #fff;
      }
      .btn-secondary {
        background: #94a3b8;
        color: #fff;
      }
      .btn-primary:disabled {
        background: #cbd5f5;
        cursor: not-allowed;
      }
      input[type="text"],
      textarea {
        width: 100%;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .field {
        display: grid;
        gap: 6px;
      }
      .form-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .section-items {
        display: grid;
        gap: 12px;
      }
      .item {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
      }
      .item-head {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 8px;
      }
      .item-head input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }
      .item-title {
        flex: 1;
        font-weight: 600;
      }
      .candidate {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px 12px;
        background: #fff;
        display: grid;
        gap: 6px;
      }
      .candidate small {
        color: #64748b;
      }
      .section-note {
        color: #64748b;
        font-size: 13px;
        margin-bottom: 12px;
      }
      .empty {
        color: #94a3b8;
        padding: 12px;
        border: 1px dashed #cbd5e1;
        border-radius: 10px;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Curate Newsletter Issue</h1>
      <p class="help">
        Load an issue JSON file, choose the main signal and items for each section,
        then download a curated JSON ready for preview/send.
      </p>

      <div class="controls">
        <input type="file" id="issueFile" accept=".json" />
        <button class="btn btn-primary" id="sendPreviewBtn" disabled onclick="sendPreview()">
          Send preview to me
        </button>
        <button class="btn btn-secondary" id="approveSendBtn" disabled onclick="approveSend()">
          Approve &amp; send to all
        </button>
        <button class="btn btn-primary" id="downloadBtn" disabled onclick="downloadCurated()">
          Download curated JSON
        </button>
        <button class="btn btn-secondary" onclick="copyCurated()" id="copyBtn" disabled>
          Copy JSON
        </button>
      </div>

      <div class="card" id="statusCard" style="display: none; margin-bottom: 20px;">
        <strong>Status:</strong>
        <span id="statusText"></span>
      </div>

      <div class="card meta-grid" id="issueMeta">
        <div>
          <div class="label">Issue Date</div>
          <div class="value" id="metaDate">-</div>
        </div>
        <div>
          <div class="label">Issue Number</div>
          <div class="value" id="metaNumber">-</div>
        </div>
        <div>
          <div class="label">Newsletter</div>
          <div class="value" id="metaName">-</div>
        </div>
      </div>

      <h2>Subject &amp; Preheader</h2>
      <div class="card form-grid">
        <div class="field">
          <label class="label" for="subject">Subject</label>
          <input type="text" id="subject" />
        </div>
        <div class="field">
          <label class="label" for="preheader">Preheader</label>
          <input type="text" id="preheader" />
        </div>
      </div>

      <h2>Main Signal</h2>
      <p class="section-note">Pick a candidate, then edit the signal details if needed.</p>
      <div class="section-items" id="signalCandidates"></div>
      <div class="card form-grid" style="margin-top: 12px;">
        <div class="field">
          <label class="label" for="signalTitle">Title</label>
          <input type="text" id="signalTitle" />
        </div>
        <div class="field">
          <label class="label" for="signalLink">Link</label>
          <input type="text" id="signalLink" />
        </div>
        <div class="field" style="grid-column: 1 / -1;">
          <label class="label" for="signalSummary">Summary</label>
          <textarea id="signalSummary"></textarea>
        </div>
        <div class="field" style="grid-column: 1 / -1;">
          <label class="label" for="signalWhy">Why it matters</label>
          <textarea id="signalWhy"></textarea>
        </div>
      </div>

      <h2>Additional Signals</h2>
      <p class="section-note">Add extra top signals to highlight under the main signal.</p>
      <div class="section-items" id="signalExtras"></div>
      <button class="btn btn-secondary" onclick="addSignalExtra()">+ Add signal</button>

      <h2>Quick Reads</h2>
      <div class="section-items" id="quickReads"></div>

      <h2>AI News</h2>
      <div class="section-items" id="aiNews"></div>

      <h2>Industry News</h2>
      <div class="section-items" id="industryNews"></div>

      <h2>Resources &amp; Community</h2>
      <div class="card">
        <div class="section-title">Datasets</div>
        <div class="section-items" id="datasetList"></div>
        <button class="btn btn-secondary" onclick="addResource('dataset')">+ Add dataset</button>
      </div>
      <div class="card" style="margin-top: 16px;">
        <div class="section-title">Tools</div>
        <div class="section-items" id="toolList"></div>
        <button class="btn btn-secondary" onclick="addResource('tool')">+ Add tool</button>
      </div>
      <div class="card" style="margin-top: 16px;">
        <div class="section-title">Events</div>
        <div class="section-items" id="eventList"></div>
        <button class="btn btn-secondary" onclick="addResource('event')">+ Add event</button>
      </div>
      <div class="card" style="margin-top: 16px;">
        <div class="section-title">Jobs</div>
        <div class="section-items" id="jobList"></div>
        <button class="btn btn-secondary" onclick="addResource('job')">+ Add job</button>
      </div>

      <h2>Pipeline Tip</h2>
      <div class="card field">
        <label class="label" for="pipelineTip">Tip</label>
        <textarea id="pipelineTip"></textarea>
      </div>

      <h2>Quote</h2>
      <div class="card form-grid">
        <div class="field" style="grid-column: 1 / -1;">
          <label class="label" for="quoteText">Quote</label>
          <textarea id="quoteText"></textarea>
        </div>
        <div class="field">
          <label class="label" for="quoteSource">Source</label>
          <input type="text" id="quoteSource" />
        </div>
      </div>
    </div>

    <script>
      let issue = null;
      let candidates = [];

      const issueFile = document.getElementById("issueFile");
      issueFile.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            issue = JSON.parse(e.target.result);
            renderIssue(issue);
            enableActions();
          } catch (err) {
            alert("Failed to parse JSON: " + err.message);
          }
        };
        reader.readAsText(file);
      });

      window.addEventListener("load", () => {
        fetch("issue.json")
          .then((resp) => {
            if (!resp.ok) throw new Error("issue.json not found");
            return resp.json();
          })
          .then((data) => {
            issue = data;
            renderIssue(issue);
            enableActions();
            issueFile.style.display = "none";
          })
          .catch(() => {
            issueFile.style.display = "inline-block";
          });
      });

      function enableActions() {
        document.getElementById("downloadBtn").disabled = false;
        document.getElementById("copyBtn").disabled = false;
        document.getElementById("sendPreviewBtn").disabled = false;
        document.getElementById("approveSendBtn").disabled = false;
      }

      function setStatus(message) {
        const card = document.getElementById("statusCard");
        const text = document.getElementById("statusText");
        text.textContent = message;
        card.style.display = "block";
      }

      function coerceList(value) {
        if (Array.isArray(value)) {
          return value;
        }
        if (value && typeof value === "object") {
          return [value];
        }
        return [];
      }

      function renderIssue(data) {
        document.getElementById("metaDate").textContent = data.issue_date || "-";
        document.getElementById("metaNumber").textContent = data.issue_number || "-";
        document.getElementById("metaName").textContent = data.newsletter_name || "-";

        document.getElementById("subject").value = data.subject || "";
        document.getElementById("preheader").value = data.preheader_text || "";

        const signal = data.signal || {};
        document.getElementById("signalTitle").value = signal.title || "";
        document.getElementById("signalLink").value = signal.link || "";
        document.getElementById("signalSummary").value = signal.summary || "";
        document.getElementById("signalWhy").value = signal.why_it_matters || "";

        renderSignalExtras(coerceList(data.signal_extras));
        renderResourceList("dataset", coerceList(data.dataset));
        renderResourceList("tool", coerceList(data.tool));
        renderResourceList("event", coerceList((data.community || {}).event));
        renderResourceList("job", coerceList((data.community || {}).job));

        document.getElementById("pipelineTip").value = data.pipeline_tip || "";

        const quote = data.quote || {};
        document.getElementById("quoteText").value = quote.text || "";
        document.getElementById("quoteSource").value = quote.source || "";

        candidates = buildCandidates(data);
        renderCandidates(candidates);

        renderSection("quick_reads", data.quick_reads || [], "quickReads");
        renderSection("ai_news", data.ai_news || [], "aiNews");
        renderSection("industry_news", data.industry_news || [], "industryNews");
      }

      function buildCandidates(data) {
        const list = [];
        if (data.signal) {
          list.push({
            source: "Signal",
            title: data.signal.title || "",
            link: data.signal.link || "",
            summary: data.signal.summary || "",
            why: data.signal.why_it_matters || "",
          });
        }
        (data.quick_reads || []).forEach((item, idx) => {
          list.push({
            source: "Quick Reads",
            title: item.title || "",
            link: item.link || "",
            summary: item.abstract || "",
            note: item.note || "",
            index: idx,
          });
        });
        (data.ai_news || []).forEach((item, idx) => {
          list.push({
            source: "AI News",
            title: item.title || "",
            link: item.link || "",
            summary: item.abstract || "",
            note: item.note || "",
            index: idx,
          });
        });
        (data.industry_news || []).forEach((item, idx) => {
          list.push({
            source: "Industry News",
            title: item.title || "",
            link: item.link || "",
            summary: item.abstract || "",
            note: item.note || "",
            index: idx,
          });
        });
        return list;
      }

      function renderCandidates(list) {
        const container = document.getElementById("signalCandidates");
        container.innerHTML = "";
        if (!list.length) {
          container.innerHTML = '<div class="empty">No candidates loaded.</div>';
          return;
        }
        list.forEach((candidate, idx) => {
          const card = document.createElement("div");
          card.className = "candidate";
          card.innerHTML = `
            <label>
              <input type="radio" name="signalCandidate" value="${idx}" />
              <strong>${escapeHtml(candidate.title || "Untitled")}</strong>
            </label>
            <small>${escapeHtml(candidate.source)}</small>
            <small>${escapeHtml(candidate.note || "")}</small>
          `;
          card.querySelector("input").addEventListener("change", () => {
            applyCandidate(candidate);
          });
          container.appendChild(card);
        });
      }

      function applyCandidate(candidate) {
        document.getElementById("signalTitle").value = candidate.title || "";
        document.getElementById("signalLink").value = candidate.link || "";
        document.getElementById("signalSummary").value = candidate.summary || "";
        document.getElementById("signalWhy").value = candidate.why || "";
      }

      function renderSection(sectionKey, items, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = '<div class="empty">No items found for this section.</div>';
          return;
        }
        items.forEach((item, index) => {
          const card = document.createElement("div");
          card.className = "item";
          card.dataset.section = sectionKey;
          card.dataset.index = String(index);
          card.innerHTML = `
            <div class="item-head">
              <input type="checkbox" class="item-select" checked />
              <span class="item-title">Include</span>
            </div>
            <div class="field">
              <label class="label">Title</label>
              <input type="text" class="item-title-input" value="${escapeAttr(item.title || "")}" />
            </div>
            <div class="field">
              <label class="label">Link</label>
              <input type="text" class="item-link-input" value="${escapeAttr(item.link || "")}" />
            </div>
            <div class="field">
              <label class="label">Note</label>
              <input type="text" class="item-note-input" value="${escapeAttr(item.note || "")}" />
            </div>
            <div class="field">
              <label class="label">Abstract</label>
              <textarea class="item-abstract-input">${escapeHtml(item.abstract || "")}</textarea>
            </div>
          `;
          container.appendChild(card);
        });
      }

      const resourceFields = {
        dataset: [
          { key: "title", label: "Title" },
          { key: "link", label: "Link" },
          { key: "summary", label: "Summary", type: "textarea" },
        ],
        tool: [
          { key: "title", label: "Title" },
          { key: "link", label: "Link" },
          { key: "summary", label: "Summary", type: "textarea" },
        ],
        event: [
          { key: "title", label: "Title" },
          { key: "date", label: "Date" },
          { key: "link", label: "Link" },
        ],
        job: [
          { key: "title", label: "Title" },
          { key: "org", label: "Org" },
          { key: "link", label: "Link" },
        ],
      };

      function renderSignalExtras(items) {
        const container = document.getElementById("signalExtras");
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = '<div class="empty">No extra signals added yet.</div>';
          return;
        }
        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "item";
          card.innerHTML = `
            <div class="item-head">
              <span class="item-title">Extra signal</span>
              <button class="btn btn-secondary" onclick="this.closest('.item').remove()">Remove</button>
            </div>
            <div class="field">
              <label class="label">Title</label>
              <input type="text" class="signal-extra-title" value="${escapeAttr(item.title || "")}" />
            </div>
            <div class="field">
              <label class="label">Link</label>
              <input type="text" class="signal-extra-link" value="${escapeAttr(item.link || "")}" />
            </div>
            <div class="field">
              <label class="label">Abstract</label>
              <textarea class="signal-extra-abstract">${escapeHtml(item.abstract || "")}</textarea>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function addSignalExtra() {
        const container = document.getElementById("signalExtras");
        const emptyState = container.querySelector(".empty");
        if (emptyState) {
          container.innerHTML = "";
        }
        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="item-head">
            <span class="item-title">Extra signal</span>
            <button class="btn btn-secondary" onclick="this.closest('.item').remove()">Remove</button>
          </div>
          <div class="field">
            <label class="label">Title</label>
            <input type="text" class="signal-extra-title" />
          </div>
          <div class="field">
            <label class="label">Link</label>
            <input type="text" class="signal-extra-link" />
          </div>
          <div class="field">
            <label class="label">Abstract</label>
            <textarea class="signal-extra-abstract"></textarea>
          </div>
        `;
        container.appendChild(card);
      }


      function renderResourceList(type, items) {
        const container = document.getElementById(`${type}List`);
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = `<div class="empty">No ${type} items yet.</div>`;
          return;
        }
        items.forEach((item, index) => {
          const card = document.createElement("div");
          card.className = "item";
          card.dataset.index = String(index);
          const fields = resourceFields[type] || [];
          const fieldsHtml = fields
            .map((field) => {
              if (field.type === "textarea") {
                return `
                <div class="field">
                  <label class="label">${field.label}</label>
                  <textarea data-key="${field.key}">${escapeHtml(item[field.key] || "")}</textarea>
                </div>`;
              }
              return `
                <div class="field">
                  <label class="label">${field.label}</label>
                  <input type="text" data-key="${field.key}" value="${escapeAttr(item[field.key] || "")}" />
                </div>`;
            })
            .join("");
          card.innerHTML = `
            <div class="item-head">
              <span class="item-title">${type} item</span>
              <button class="btn btn-secondary" onclick="this.closest('.item').remove()">Remove</button>
            </div>
            ${fieldsHtml}
          `;
          container.appendChild(card);
        });
      }

      function addResource(type) {
        const container = document.getElementById(`${type}List`);
        const emptyState = container.querySelector(".empty");
        if (emptyState) {
          container.innerHTML = "";
        }
        const card = document.createElement("div");
        card.className = "item";
        const fields = resourceFields[type] || [];
        const fieldsHtml = fields
          .map((field) => {
            if (field.type === "textarea") {
              return `
                <div class="field">
                  <label class="label">${field.label}</label>
                  <textarea data-key="${field.key}"></textarea>
                </div>`;
            }
            return `
                <div class="field">
                  <label class="label">${field.label}</label>
                  <input type="text" data-key="${field.key}" />
                </div>`;
          })
          .join("");
        card.innerHTML = `
          <div class="item-head">
            <span class="item-title">${type} item</span>
            <button class="btn btn-secondary" onclick="this.closest('.item').remove()">Remove</button>
          </div>
          ${fieldsHtml}
        `;
        container.appendChild(card);
      }

      function collectResource(type) {
        const container = document.getElementById(`${type}List`);
        const items = [];
        container.querySelectorAll(".item").forEach((card) => {
          const data = {};
          card.querySelectorAll("[data-key]").forEach((input) => {
            data[input.dataset.key] = input.value.trim();
          });
          if (Object.values(data).some((val) => val)) {
            items.push(data);
          }
        });
        return items;
      }

      function collectSignalExtras() {
        const items = [];
        document.querySelectorAll("#signalExtras .item").forEach((card) => {
          const title = card.querySelector(".signal-extra-title")?.value.trim();
          const link = card.querySelector(".signal-extra-link")?.value.trim();
          const abstract = card.querySelector(".signal-extra-abstract")?.value.trim();
          if (!title && !link && !abstract) {
            return;
          }
          items.push({ title, link, abstract });
        });
        return items;
      }

      function collectItems(sectionKey, originalItems) {
        const items = [];
        document.querySelectorAll(`.item[data-section="${sectionKey}"]`).forEach((card) => {
          const selected = card.querySelector(".item-select").checked;
          const title = card.querySelector(".item-title-input").value.trim();
          const link = card.querySelector(".item-link-input").value.trim();
          const note = card.querySelector(".item-note-input").value.trim();
          const abstract = card.querySelector(".item-abstract-input").value.trim();
          if (!selected) return;
          items.push({ title, link, note, abstract });
        });
        if (!items.length) {
          return originalItems || [];
        }
        return items;
      }

      function buildCurated() {
        if (!issue) return null;
        const curated = JSON.parse(JSON.stringify(issue));

        curated.subject = document.getElementById("subject").value.trim();
        curated.preheader_text = document.getElementById("preheader").value.trim();

        curated.signal = {
          title: document.getElementById("signalTitle").value.trim(),
          link: document.getElementById("signalLink").value.trim(),
          summary: document.getElementById("signalSummary").value.trim(),
          why_it_matters: document.getElementById("signalWhy").value.trim(),
        };

        curated.signal_extras = collectSignalExtras();
        curated.quick_reads = collectItems("quick_reads", issue.quick_reads);
        curated.ai_news = collectItems("ai_news", issue.ai_news);
        curated.industry_news = collectItems("industry_news", issue.industry_news);

        curated.dataset = collectResource("dataset");
        curated.tool = collectResource("tool");
        curated.community = curated.community || {};
        curated.community.event = collectResource("event");
        curated.community.job = collectResource("job");

        curated.pipeline_tip = document.getElementById("pipelineTip").value.trim();
        curated.quote = {
          text: document.getElementById("quoteText").value.trim(),
          source: document.getElementById("quoteSource").value.trim(),
        };

        return curated;
      }

      function downloadCurated() {
        const curated = buildCurated();
        if (!curated) return;
        const date = curated.issue_date || "issue";
        const blob = new Blob([JSON.stringify(curated, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `curated-${date}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function copyCurated() {
        const curated = buildCurated();
        if (!curated) return;
        const payload = JSON.stringify(curated, null, 2);
        navigator.clipboard.writeText(payload).then(() => {
          alert("Curated JSON copied to clipboard.");
        });
      }

      async function sendPreview() {
        const curated = buildCurated();
        if (!curated) return;
        setStatus("Sending preview email...");
        await postCurated("/send-preview", curated);
      }

      async function approveSend() {
        if (!confirm("Send to all subscribers now?")) return;
        const curated = buildCurated();
        if (!curated) return;
        setStatus("Sending to all subscribers...");
        await postCurated("/approve-send", curated);
      }

      async function postCurated(endpoint, curated) {
        try {
          const resp = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(curated),
          });
          const payload = await resp.json();
          if (!resp.ok) {
            setStatus(payload.error || "Request failed.");
            return;
          }
          setStatus(payload.message || "Done.");
        } catch (err) {
          setStatus("Request failed: " + err.message);
        }
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function escapeAttr(text) {
        return escapeHtml(text).replace(/"/g, "&quot;");
      }
    </script>
  </body>
</html>
